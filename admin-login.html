<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SmartStruct â€” Admin Access</title>
<!-- No indexing by search engines -->
<meta name="robots" content="noindex, nofollow, noarchive">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800;900&family=JetBrains+Mono:wght@400;600;700&display=swap">
<style>
  :root {
    --gold: #E8B84B; --gold2: #C49030; --gold3: #F5D07A;
    --bg: #060A10; --bg2: #0C1220; --bg3: #0F1828;
    --border: rgba(255,255,255,0.06); --border2: rgba(255,255,255,0.1);
    --text: #EDF2F7; --muted: #8892A4; --dim: #4A5B7A;
    --green: #34C38F; --red: #F04E6A;
    --radius: 12px;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html { scroll-behavior: smooth; }

  body {
    font-family: 'Tajawal', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    position: relative;
  }

  /* Animated background */
  .bg-layer {
    position: fixed; inset: 0; z-index: 0; pointer-events: none;
  }
  .bg-grid {
    position: absolute; inset: 0;
    background-image:
      linear-gradient(rgba(232,184,75,.018) 1px, transparent 1px),
      linear-gradient(90deg, rgba(232,184,75,.018) 1px, transparent 1px);
    background-size: 50px 50px;
  }
  .bg-glow-1 {
    position: absolute; top: -20%; left: 50%; transform: translateX(-50%);
    width: 700px; height: 600px;
    background: radial-gradient(ellipse, rgba(232,184,75,.07) 0%, transparent 65%);
    animation: pulseGlow 6s ease-in-out infinite;
  }
  .bg-glow-2 {
    position: absolute; bottom: -20%; right: -10%;
    width: 500px; height: 500px;
    background: radial-gradient(ellipse, rgba(240,78,106,.04) 0%, transparent 65%);
    animation: pulseGlow 8s ease-in-out infinite reverse;
  }
  @keyframes pulseGlow {
    0%, 100% { opacity: 0.6; transform: translateX(-50%) scale(1); }
    50% { opacity: 1; transform: translateX(-50%) scale(1.08); }
  }

  /* Noise texture */
  body::after {
    content: '';
    position: fixed; inset: 0; z-index: 1;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none; opacity: .5;
  }

  /* Card */
  .card {
    position: relative; z-index: 10;
    background: rgba(12, 18, 32, 0.9);
    border: 1px solid rgba(232,184,75,.15);
    border-radius: 24px;
    padding: 2.5rem 2.2rem;
    width: 100%; max-width: 420px;
    margin: 1rem;
    box-shadow:
      0 0 0 1px rgba(232,184,75,.06),
      0 40px 100px rgba(0,0,0,.7),
      inset 0 1px 0 rgba(255,255,255,.05);
    animation: cardIn .5s cubic-bezier(0.34, 1.56, 0.64, 1) both;
    backdrop-filter: blur(20px);
  }
  @keyframes cardIn {
    from { opacity: 0; transform: translateY(28px) scale(0.95); }
    to   { opacity: 1; transform: none; }
  }

  /* Header */
  .card-header {
    text-align: center; margin-bottom: 2rem;
  }
  .logo-icon {
    width: 60px; height: 60px;
    background: linear-gradient(135deg, #E8B84B, #C49030);
    border-radius: 16px;
    display: inline-flex; align-items: center; justify-content: center;
    font-size: 1.8rem;
    margin-bottom: 1rem;
    box-shadow: 0 8px 28px rgba(232,184,75,.35);
  }
  .card-title {
    font-size: 1.35rem; font-weight: 900;
    color: var(--text);
    margin-bottom: .3rem;
  }
  .card-sub {
    font-size: .8rem; color: var(--dim);
    line-height: 1.5;
  }

  /* Security badge */
  .sec-badge {
    display: inline-flex; align-items: center; gap: .4rem;
    background: rgba(240,78,106,.08);
    border: 1px solid rgba(240,78,106,.2);
    border-radius: 20px;
    padding: .25rem .85rem;
    font-size: .7rem; font-weight: 800;
    color: #F04E6A;
    margin-bottom: 1.5rem;
    letter-spacing: .3px;
  }
  .sec-dot {
    width: 6px; height: 6px; border-radius: 50%;
    background: #F04E6A;
    animation: blink 1.5s ease-in-out infinite;
  }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.3} }

  /* Form */
  .form-group { margin-bottom: 1.1rem; }
  .form-label {
    display: block;
    font-size: .75rem; font-weight: 800;
    color: var(--muted);
    margin-bottom: .4rem;
    letter-spacing: .3px;
  }
  .form-input {
    width: 100%;
    padding: .75rem 1rem;
    background: rgba(255,255,255,.04);
    border: 1px solid var(--border2);
    border-radius: var(--radius);
    color: var(--text);
    font-family: 'Tajawal', sans-serif;
    font-size: .9rem;
    outline: none;
    transition: border-color .2s, box-shadow .2s;
  }
  .form-input:focus {
    border-color: var(--gold);
    box-shadow: 0 0 0 3px rgba(232,184,75,.12);
  }
  .form-input::placeholder { color: var(--dim); }

  .pass-wrap { position: relative; }
  .pass-toggle {
    position: absolute; left: .75rem; top: 50%; transform: translateY(-50%);
    background: none; border: none; cursor: pointer;
    color: var(--dim); font-size: 1rem;
    transition: color .2s;
  }
  .pass-toggle:hover { color: var(--muted); }
  .pass-wrap .form-input { padding-left: 2.5rem; }

  /* Security key field */
  .sec-field-wrap {
    background: rgba(232,184,75,.04);
    border: 1px solid rgba(232,184,75,.12);
    border-radius: 14px;
    padding: 1rem;
    margin-bottom: 1.1rem;
  }
  .sec-field-label {
    font-size: .7rem; font-weight: 800;
    color: var(--gold); margin-bottom: .5rem;
    display: flex; align-items: center; gap: .4rem;
  }

  /* Button */
  .btn-login {
    width: 100%;
    padding: .9rem;
    background: linear-gradient(135deg, #E8B84B, #C49030);
    color: #09120A;
    border: none; border-radius: 14px;
    font-family: 'Tajawal', sans-serif;
    font-size: 1rem; font-weight: 900;
    cursor: pointer;
    transition: all .25s;
    box-shadow: 0 4px 20px rgba(232,184,75,.35);
    display: flex; align-items: center; justify-content: center; gap: .5rem;
    margin-top: .5rem;
  }
  .btn-login:hover {
    box-shadow: 0 8px 32px rgba(232,184,75,.5);
    transform: translateY(-1px);
  }
  .btn-login:active { transform: scale(.97); }
  .btn-login:disabled {
    opacity: .6; cursor: not-allowed;
    transform: none; box-shadow: none;
  }

  /* Alert */
  .alert {
    padding: .75rem 1rem; border-radius: var(--radius);
    font-size: .85rem; display: flex; align-items: center; gap: .5rem;
    margin-bottom: 1rem; display: none;
  }
  .alert-error {
    background: rgba(240,78,106,.1);
    border: 1px solid rgba(240,78,106,.3);
    color: #f79fa9;
  }
  .alert-warn {
    background: rgba(232,184,75,.08);
    border: 1px solid rgba(232,184,75,.25);
    color: var(--gold);
  }

  /* Footer */
  .card-footer {
    margin-top: 1.8rem; padding-top: 1.2rem;
    border-top: 1px solid var(--border);
    text-align: center;
  }
  .back-link {
    font-size: .78rem; color: var(--dim);
    text-decoration: none;
    cursor: pointer;
    transition: color .2s;
    display: inline-flex; align-items: center; gap: .3rem;
  }
  .back-link:hover { color: var(--muted); }

  /* Attempts counter */
  .attempts-bar {
    display: flex; gap: .3rem; justify-content: center;
    margin-top: .8rem;
  }
  .attempt-dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: rgba(255,255,255,.1);
    transition: background .3s;
  }
  .attempt-dot.used { background: var(--red); }

  /* Lockout overlay */
  .lockout {
    text-align: center; padding: .5rem 0;
    display: none;
  }
  .lockout-icon { font-size: 2.5rem; margin-bottom: .8rem; }
  .lockout-title {
    font-size: 1.1rem; font-weight: 900;
    color: #f79fa9; margin-bottom: .4rem;
  }
  .lockout-text { font-size: .82rem; color: var(--dim); line-height: 1.6; }
  .lockout-timer {
    font-size: 1.8rem; font-weight: 900;
    font-family: 'JetBrains Mono', monospace;
    color: var(--red); margin: .8rem 0;
  }

  /* Loading spinner */
  @keyframes spin { to { transform: rotate(360deg); } }
  .spinner {
    width: 18px; height: 18px;
    border: 2px solid rgba(9,18,10,.3);
    border-top-color: #09120A;
    border-radius: 50%;
    animation: spin .7s linear infinite;
    display: none;
  }

  /* Success state */
  .success-state {
    text-align: center; padding: 1rem 0;
    display: none;
    animation: fadeIn .4s ease;
  }
  @keyframes fadeIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:none} }
  .success-icon { font-size: 3rem; margin-bottom: 1rem; }
  .success-title {
    font-size: 1.2rem; font-weight: 900;
    color: var(--green); margin-bottom: .4rem;
  }
  .success-sub { font-size: .82rem; color: var(--dim); }
</style>
</head>
<body>

<!-- Animated Background -->
<div class="bg-layer">
  <div class="bg-grid"></div>
  <div class="bg-glow-1"></div>
  <div class="bg-glow-2"></div>
</div>

<!-- Login Card -->
<div class="card" id="mainCard">

  <!-- Header -->
  <div class="card-header">
    <div class="logo-icon">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 36" width="32" height="32">
        <defs>
          <linearGradient id="ssGA" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#09120A"/>
            <stop offset="100%" stop-color="#09120A"/>
          </linearGradient>
        </defs>
        <rect x="4" y="5" width="28" height="5" rx="2.5" fill="#09120A"/>
        <rect x="4" y="15.5" width="20" height="5" rx="2.5" fill="#09120A" opacity=".82"/>
        <rect x="4" y="26" width="13" height="5" rx="2.5" fill="#09120A" opacity=".6"/>
        <rect x="4" y="5" width="5" height="26" rx="2.5" fill="#09120A" opacity=".35"/>
      </svg>
    </div>
    <div class="card-title">SmartStruct â€” Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
    <div class="card-sub">Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù…Ø®ØµØµØ© Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… ÙÙ‚Ø·</div>
  </div>

  <div style="text-align:center; margin-bottom:1.5rem">
    <div class="sec-badge">
      <div class="sec-dot"></div>
      Ù…Ù†Ø·Ù‚Ø© Ù…Ù‚ÙŠØ¯Ø© â€” Admin Only
    </div>
  </div>

  <!-- Form Content -->
  <div id="formContent">
    <!-- Error Alert -->
    <div class="alert alert-error" id="alertError">âŒ <span id="alertMsg">Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©</span></div>
    <div class="alert alert-warn" id="alertWarn">âš ï¸ <span id="alertWarnMsg"></span></div>

    <!-- Email -->
    <div class="form-group">
      <label class="form-label">ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
      <input class="form-input" id="adminEmail" type="email" placeholder="admin@smartbtp.dz" dir="ltr" autocomplete="off">
    </div>

    <!-- Password -->
    <div class="form-group">
      <label class="form-label">ğŸ”‘ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
      <div class="pass-wrap">
        <input class="form-input" id="adminPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" dir="ltr" autocomplete="off">
        <button class="pass-toggle" type="button" onclick="togglePass()">ğŸ‘ï¸</button>
      </div>
    </div>

    <!-- Security Key (2nd Factor) -->
    <div class="sec-field-wrap">
      <div class="sec-field-label">ğŸ›¡ï¸ Ù…ÙØªØ§Ø­ Ø§Ù„Ø£Ù…Ø§Ù† (Ø·Ø¨Ù‚Ø© Ø«Ø§Ù†ÙŠØ©)</div>
      <div class="form-group" style="margin-bottom:0">
        <input class="form-input" id="adminSecKey" type="password" placeholder="Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ø³Ø±ÙŠ" dir="ltr" autocomplete="off"
          style="background:rgba(232,184,75,.04);border-color:rgba(232,184,75,.2)">
      </div>
    </div>

    <!-- Login Button -->
    <button class="btn-login" id="loginBtn" onclick="doAdminLogin()">
      <span id="btnText">ğŸ”“ Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù†</span>
      <div class="spinner" id="spinner"></div>
    </button>

    <!-- Attempts Dots -->
    <div class="attempts-bar" id="attemptsDots">
      <div class="attempt-dot" id="dot1"></div>
      <div class="attempt-dot" id="dot2"></div>
      <div class="attempt-dot" id="dot3"></div>
      <div class="attempt-dot" id="dot4"></div>
      <div class="attempt-dot" id="dot5"></div>
    </div>
  </div>

  <!-- Lockout State -->
  <div class="lockout" id="lockoutState">
    <div class="lockout-icon">ğŸ”’</div>
    <div class="lockout-title">ØªÙ… Ù‚ÙÙ„ Ø§Ù„ÙˆØµÙˆÙ„ Ù…Ø¤Ù‚ØªØ§Ù‹</div>
    <div class="lockout-text">ØªØ¬Ø§ÙˆØ²Øª Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§.<br>ÙŠÙØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±:</div>
    <div class="lockout-timer" id="lockTimer">05:00</div>
    <div class="lockout-text">Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</div>
  </div>

  <!-- Success State -->
  <div class="success-state" id="successState">
    <div class="success-icon">âœ…</div>
    <div class="success-title">ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­</div>
    <div class="success-sub">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…...</div>
  </div>

  <!-- Footer -->\n  <div class=\"card-footer\">\n    <a class=\"back-link\" onclick=\"goBack()\">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>\n  </div>\n\n</div>\n\n<!-- User Management Panel (shown after login) -->\n<div id=\"adminPanel\" style=\"display:none;position:relative;z-index:10;width:100%;max-width:680px;margin:2rem auto;padding:0 1rem\">\n  <div style=\"background:rgba(12,18,32,0.95);border:1px solid rgba(232,184,75,.2);border-radius:20px;padding:2rem;backdrop-filter:blur(20px);box-shadow:0 40px 100px rgba(0,0,0,.7)\">\n    \n    <div style=\"display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem\">\n      <div>\n        <div style=\"font-size:1.2rem;font-weight:800;color:#E8B84B\">ğŸ›¡ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</div>\n        <div style=\"font-size:.8rem;color:#8892A4;margin-top:.3rem\">Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„Ù…Ø¤Ø³Ø³Ø§Øª Ù…Ù† localStorage ÙˆSupabase</div>\n      </div>\n      <button onclick=\"loadUsersPanel()\" style=\"background:rgba(232,184,75,.1);border:1px solid rgba(232,184,75,.3);color:#E8B84B;border-radius:10px;padding:.5rem 1rem;cursor:pointer;font-family:Tajawal\">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>\n    </div>\n\n    <!-- Filters -->\n    <div style=\"display:flex;gap:.6rem;margin-bottom:1rem;flex-wrap:wrap\">\n      <input id=\"searchUser\" type=\"text\" placeholder=\"ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø£Ùˆ Ø¨Ø±ÙŠØ¯...\" oninput=\"filterUsers()\" \n        style=\"flex:1;min-width:160px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:.6rem 1rem;color:#EDF2F7;font-family:Tajawal;font-size:.9rem;outline:none\">\n      <select id=\"filterRole\" onchange=\"filterUsers()\" style=\"background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:.6rem 1rem;color:#EDF2F7;font-family:Tajawal;cursor:pointer\">\n        <option value=\"\">ÙƒÙ„ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±</option>\n        <option value=\"admin\">Ù…Ø³Ø¤ÙˆÙ„</option>\n        <option value=\"manager\">Ù…Ø¯ÙŠØ±</option>\n        <option value=\"user\">Ù…Ø³ØªØ®Ø¯Ù…</option>\n      </select>\n    </div>\n\n    <!-- Users List -->\n    <div id=\"usersListPanel\" style=\"max-height:400px;overflow-y:auto\"></div>\n\n    <!-- Bulk Actions -->\n    <div style=\"margin-top:1.2rem;padding-top:1rem;border-top:1px solid rgba(255,255,255,.06);display:flex;gap:.7rem;flex-wrap:wrap\">\n      <button onclick=\"deleteSelectedUsers()\" id=\"deleteSelectedBtn\" disabled style=\"background:rgba(240,78,106,.15);border:1px solid rgba(240,78,106,.3);color:#F04E6A;border-radius:10px;padding:.55rem 1.2rem;cursor:pointer;font-family:Tajawal;font-weight:700;opacity:.5\">\n        ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ù‘Ø¯ÙŠÙ†\n      </button>\n      <div id=\"panelStatus\" style=\"color:#8892A4;font-size:.82rem;display:flex;align-items:center\"></div>\n    </div>\n  </div>\n</div>\n\n<style>\n.user-row {\n  display:flex;align-items:center;gap:.8rem;padding:.75rem 1rem;border-radius:12px;\n  margin-bottom:.5rem;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);\n  transition:.2s;\n}\n.user-row:hover { background:rgba(255,255,255,.06); border-color:rgba(255,255,255,.1); }\n.user-row.selected { background:rgba(240,78,106,.08); border-color:rgba(240,78,106,.3); }\n.user-avatar {\n  width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;\n  font-weight:800;font-size:.95rem;flex-shrink:0;\n}\n.badge-role {\n  font-size:.68rem;padding:.2rem .6rem;border-radius:20px;font-weight:700;\n}\n.user-check { width:18px;height:18px;accent-color:#F04E6A;cursor:pointer; }\n.delete-one-btn {\n  background:rgba(240,78,106,.12);border:1px solid rgba(240,78,106,.2);color:#F04E6A;\n  border-radius:8px;padding:.3rem .7rem;cursor:pointer;font-family:Tajawal;font-size:.8rem;\n  transition:.2s;white-space:nowrap;\n}\n.delete-one-btn:hover { background:rgba(240,78,106,.25); }\n</style>\n\n<script>\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n//  Panel: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nlet _allUsers = [];\nlet _selectedIds = new Set();\n\nasync function loadUsersPanel() {\n  const container = document.getElementById('usersListPanel');\n  const status = document.getElementById('panelStatus');\n  container.innerHTML = '<div style=\"text-align:center;padding:2rem;color:#8892A4\">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';\n  _selectedIds.clear();\n  updateDeleteBtn();\n\n  try {\n    // Ø¬Ù„Ø¨ Ù…Ù† Supabase\n    const cfg = getSbCfg();\n    let sbUsers = [];\n    if (cfg) {\n      const res = await fetch(`${cfg.url}/rest/v1/users?select=*&order=id.asc`, {\n        headers: { 'apikey': cfg.key, 'Authorization': `Bearer ${cfg.key}`, 'Content-Type': 'application/json' }\n      });\n      if (res.ok) sbUsers = await res.json();\n    }\n\n    // Ø¬Ù„Ø¨ Ù…Ù† localStorage\n    let lsUsers = [];\n    try { lsUsers = JSON.parse(localStorage.getItem('sbtp5_users') || '[]'); } catch{}\n\n    // Ø¯Ù…Ø¬ (Supabase Ù„Ù‡ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©)\n    const merged = {};\n    lsUsers.forEach(u => { merged[u.id] = { ...u, _source: 'local' }; });\n    sbUsers.forEach(u => { merged[u.id] = { ...u, _source: 'cloud' }; });\n    _allUsers = Object.values(merged);\n\n    status.textContent = `${_allUsers.length} Ø­Ø³Ø§Ø¨ (${sbUsers.length} Ø³Ø­Ø§Ø¨ÙŠØŒ ${lsUsers.length} Ù…Ø­Ù„ÙŠ)`;\n    renderUsers(_allUsers);\n  } catch(e) {\n    container.innerHTML = `<div style=\"color:#F04E6A;text-align:center;padding:1.5rem\">âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„: ${e.message}</div>`;\n  }\n}\n\nfunction renderUsers(users) {\n  const container = document.getElementById('usersListPanel');\n  if (!users.length) {\n    container.innerHTML = '<div style=\"text-align:center;padding:2rem;color:#8892A4\">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø³Ø§Ø¨Ø§Øª</div>';\n    return;\n  }\n\n  const colors = ['#E8B84B','#4A90E2','#34C38F','#9B59B6','#E74C3C','#1ABC9C'];\n  container.innerHTML = users.map(u => {\n    const initials = (u.full_name || u.email || '?').slice(0,2);\n    const color = colors[(u.id || 0) % colors.length];\n    const isSelected = _selectedIds.has(u.id);\n    const roleColor = u.is_admin ? '#E8B84B' : u.role === 'manager' ? '#4A90E2' : '#8892A4';\n    const roleLabel = u.is_admin ? 'Ù…Ø³Ø¤ÙˆÙ„' : (u.role === 'manager' ? 'Ù…Ø¯ÙŠØ±' : 'Ù…Ø³ØªØ®Ø¯Ù…');\n    const sourceIcon = u._source === 'cloud' ? 'â˜ï¸' : 'ğŸ’¾';\n\n    return `<div class=\"user-row${isSelected ? ' selected' : ''}\" id=\"urow_${u.id}\">\n      <input type=\"checkbox\" class=\"user-check\" ${isSelected ? 'checked' : ''} onchange=\"toggleSelect(${u.id})\" ${u.is_admin ? 'title=\"Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ\"' : ''}>\n      <div class=\"user-avatar\" style=\"background:${color}22;color:${color}\">${initials}</div>\n      <div style=\"flex:1;min-width:0\">\n        <div style=\"font-weight:700;font-size:.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis\">${u.full_name || 'â€”'}</div>\n        <div style=\"font-size:.75rem;color:#8892A4\">${u.email || 'â€”'} &nbsp;â€¢&nbsp; ${sourceIcon} ${u.tenant_id ? 'Ù…Ø¤Ø³Ø³Ø© #'+u.tenant_id : 'Ø¨Ø¯ÙˆÙ† Ù…Ø¤Ø³Ø³Ø©'}</div>\n      </div>\n      <span class=\"badge-role\" style=\"background:${roleColor}22;color:${roleColor}\">${roleLabel}</span>\n      <button class=\"delete-one-btn\" onclick=\"deleteSingleUser(${u.id}, '${(u.full_name || u.email || '').replace(/'/g,\"'\")}')\">\n        ğŸ—‘ï¸ Ø­Ø°Ù\n      </button>\n    </div>`;\n  }).join('');\n}\n\nfunction filterUsers() {\n  const q = (document.getElementById('searchUser')?.value || '').toLowerCase();\n  const role = document.getElementById('filterRole')?.value || '';\n  const filtered = _allUsers.filter(u => {\n    const matchQ = !q || (u.full_name || '').toLowerCase().includes(q) || (u.email || '').toLowerCase().includes(q);\n    const matchRole = !role || u.role === role || (role === 'admin' && u.is_admin);\n    return matchQ && matchRole;\n  });\n  renderUsers(filtered);\n}\n\nfunction toggleSelect(id) {\n  if (_selectedIds.has(id)) _selectedIds.delete(id);\n  else _selectedIds.add(id);\n  const row = document.getElementById('urow_' + id);\n  if (row) row.classList.toggle('selected', _selectedIds.has(id));\n  updateDeleteBtn();\n}\n\nfunction updateDeleteBtn() {\n  const btn = document.getElementById('deleteSelectedBtn');\n  if (!btn) return;\n  const count = _selectedIds.size;\n  btn.disabled = count === 0;\n  btn.style.opacity = count > 0 ? '1' : '.5';\n  btn.style.cursor = count > 0 ? 'pointer' : 'default';\n  btn.innerHTML = count > 0 ? `ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ù‘Ø¯ÙŠÙ† (${count})` : 'ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ù‘Ø¯ÙŠÙ†';\n}\n\nasync function deleteSingleUser(id, name) {\n  if (!confirm(`âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø­Ø³Ø§Ø¨ \"${name}\"ØŸ\\n\\nØ³ÙŠÙØ­Ø°Ù Ù…Ù† localStorage ÙˆSupabase.`)) return;\n  await doDeleteUsers([id]);\n}\n\nasync function deleteSelectedUsers() {\n  const ids = [..._selectedIds];\n  if (!ids.length) return;\n  // ØªØ­Ù‚Ù‚: Ù„Ø§ Ù†Ø­Ø°Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ\n  const adminUsers = _allUsers.filter(u => ids.includes(u.id) && u.is_admin && !u.tenant_id);\n  if (adminUsers.length) {\n    alert('âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù†Ø¸Ø§Ù…!');\n    return;\n  }\n  if (!confirm(`âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ${ids.length} Ø­Ø³Ø§Ø¨ØŸ\\n\\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!`)) return;\n  await doDeleteUsers(ids);\n}\n\nasync function doDeleteUsers(ids) {\n  const status = document.getElementById('panelStatus');\n  status.innerHTML = `<span style=\"color:#F04E6A\">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...</span>`;\n\n  let deletedLocal = 0, deletedCloud = 0, errors = [];\n\n  // 1) Ø­Ø°Ù Ù…Ù† localStorage\n  try {\n    let lsUsers = JSON.parse(localStorage.getItem('sbtp5_users') || '[]');\n    const before = lsUsers.length;\n    lsUsers = lsUsers.filter(u => !ids.includes(u.id));\n    localStorage.setItem('sbtp5_users', JSON.stringify(lsUsers));\n    deletedLocal = before - lsUsers.length;\n  } catch(e) { errors.push('localStorage: ' + e.message); }\n\n  // 2) Ø­Ø°Ù Ù…Ù† Supabase\n  const cfg = getSbCfg();\n  if (cfg) {\n    for (const id of ids) {\n      try {\n        const res = await fetch(`${cfg.url}/rest/v1/users?id=eq.${id}`, {\n          method: 'DELETE',\n          headers: {\n            'apikey': cfg.key, 'Authorization': `Bearer ${cfg.key}`,\n            'Content-Type': 'application/json', 'Prefer': 'return=representation'\n          }\n        });\n        if (res.ok) deletedCloud++;\n        else {\n          const t = await res.text();\n          errors.push(`Supabase #${id}: ${t.slice(0,60)}`);\n        }\n      } catch(e) { errors.push(`Supabase #${id}: ${e.message}`); }\n    }\n  }\n\n  // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©\n  if (errors.length === 0) {\n    status.innerHTML = `<span style=\"color:#34C38F\">âœ… Ø­ÙØ°Ù ${deletedLocal} Ù…Ø­Ù„ÙŠ + ${deletedCloud} Ø³Ø­Ø§Ø¨ÙŠ</span>`;\n  } else {\n    status.innerHTML = `<span style=\"color:#F04E6A\">âš ï¸ ${deletedLocal+deletedCloud} Ù…Ø­Ø°ÙˆÙ â€” ${errors[0]}</span>`;\n  }\n\n  await loadUsersPanel();\n}\n\nfunction getSbCfg() {\n  try {\n    // HARDCODED first\n    if (typeof SUPABASE_HARDCODED !== 'undefined' && SUPABASE_HARDCODED?.url) {\n      return { url: SUPABASE_HARDCODED.url, key: SUPABASE_HARDCODED.anonKey };\n    }\n    const saved = JSON.parse(localStorage.getItem('sbtp_supabase_config') || '{}');\n    if (saved.url && saved.anonKey) return { url: saved.url, key: saved.anonKey };\n  } catch{}\n  return null;\n}\n\n// Ø£Ø¶Ù Ù…ÙØ§ØªÙŠØ­ Supabase Hardcoded Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©\nconst SUPABASE_HARDCODED = {\n  url:     'https://udinbxcnehcevajhrral.supabase.co',\n  anonKey: 'sb_publishable_kl2FcK_mMUfQ_EqGK21KkA_4M4ZEdMZ'\n};\n</script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SmartStruct â€” Secure Admin Login
//  Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ù‚Ù‰ Ø³Ø±ÙŠØ§Ù‹ ÙˆÙ„Ø§ ÙŠÙØ´Ø§Ø±Ùƒ Ø±Ø§Ø¨Ø·Ù‡
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù† â”€â”€
const ADMIN_CONFIG = {
  maxAttempts: 5,
  lockoutMinutes: 5,
  // Ù…ÙØªØ§Ø­ Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ø«Ø§Ù†ÙŠ â€” ÙŠØ¬Ø¨ ØªØºÙŠÙŠØ±Ù‡ Ù…Ù† Ù‚ÙØ¨Ù„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
  securityKey: 'SSTR-ADMIN-2025',
};

// â”€â”€ DB: Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† localStorage (Ù…Ø¹ Supabase fallback) â”€â”€
async function getUsersAsync() {
  // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ù…Ù† Supabase Ø£ÙˆÙ„Ø§Ù‹
  try {
    const cfg = JSON.parse(localStorage.getItem('sbtp_supabase_config') || '{}');
    if (cfg.url && cfg.anonKey) {
      const resp = await fetch(`${cfg.url}/rest/v1/users?is_admin=eq.true&is_active=eq.true`, {
        headers: {
          'apikey': cfg.anonKey,
          'Authorization': `Bearer ${cfg.anonKey}`,
          'Content-Type': 'application/json'
        }
      });
      if (resp.ok) {
        const users = await resp.json();
        if (users.length) return users;
      }
    }
  } catch(e) {}
  // Fallback to localStorage
  return getUsers();
}

function getUsers() {
  try {
    // Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„ØµØ­ÙŠØ­ ÙŠØ·Ø§Ø¨Ù‚ Ù…Ø§ ÙŠØ³ØªØ®Ø¯Ù…Ù‡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ: sbtp5_users
    const raw = localStorage.getItem('sbtp5_users');
    if (raw) return JSON.parse(raw);
    // Fallback: Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ØªÙÙ‡ÙŠÙÙ‘Ø£ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯
    return [
      {
        id: 1, tenant_id: null, full_name: 'Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…',
        email: 'admin@smartbtp.dz', password: 'Admin@SmartBTP2025',
        role: 'admin', is_admin: true, is_active: true
      }
    ];
  } catch(e) { return []; }
}

// â”€â”€ ØªÙ‡ÙŠØ¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§Ø±ØºØ© â”€â”€
function ensureDefaultAdmin() {
  try {
    const initialized = localStorage.getItem('sbtp5_initialized');
    if (!initialized) {
      // Ù„Ù… ÙŠÙØ´ØºÙÙ‘Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø¨Ø¹Ø¯ â€” Ù†Ø­ÙØ¸ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
      const existing = localStorage.getItem('sbtp5_users');
      if (!existing) {
        localStorage.setItem('sbtp5_users', JSON.stringify([
          { id:1, tenant_id:null, full_name:'Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…', email:'admin@smartbtp.dz',
            password:'Admin@SmartBTP2025', role:'admin', is_admin:true, is_active:true }
        ]));
      }
    }
  } catch(e) {}
}

// â”€â”€ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª â”€â”€
let attempts = parseInt(sessionStorage.getItem('adm_att') || '0');
let lockUntil = parseInt(sessionStorage.getItem('adm_lock') || '0');

// â”€â”€ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ â”€â”€
window.addEventListener('DOMContentLoaded', () => {
  ensureDefaultAdmin();
  checkLockout();
  document.getElementById('adminEmail').focus();
  // Enter key
  ['adminEmail','adminPass','adminSecKey'].forEach(id => {
    document.getElementById(id).addEventListener('keydown', e => {
      if (e.key === 'Enter') doAdminLogin();
    });
  });
  renderDots();
});

// â”€â”€ Ø±Ø³Ù… Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª â”€â”€
function renderDots() {
  for (let i = 1; i <= 5; i++) {
    const d = document.getElementById('dot' + i);
    if (d) d.className = 'attempt-dot' + (i <= attempts ? ' used' : '');
  }
}

// â”€â”€ ÙØ­Øµ Ø§Ù„Ù‚ÙÙ„ â”€â”€
function checkLockout() {
  if (lockUntil && Date.now() < lockUntil) {
    showLockout();
    startCountdown();
    return true;
  } else if (lockUntil && Date.now() >= lockUntil) {
    // Reset after lockout
    attempts = 0;
    sessionStorage.removeItem('adm_att');
    sessionStorage.removeItem('adm_lock');
    lockUntil = 0;
  }
  return false;
}

// â”€â”€ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù…Ù† â”€â”€
async function doAdminLogin() {
  if (checkLockout()) return;

  const email   = document.getElementById('adminEmail')?.value?.trim().toLowerCase();
  const pass    = document.getElementById('adminPass')?.value;
  const secKey  = document.getElementById('adminSecKey')?.value?.trim();

  // Validate fields
  if (!email || !pass || !secKey) {
    showError('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ù…Ø§ ÙÙŠÙ‡Ø§ Ù…ÙØªØ§Ø­ Ø§Ù„Ø£Ù…Ø§Ù†');
    return;
  }

  // Show loading
  setLoading(true);
  await delay(800); // Anti-brute-force delay

  // 1ï¸âƒ£ Check security key
  if (secKey !== ADMIN_CONFIG.securityKey) {
    setLoading(false);
    recordFail('Ù…ÙØªØ§Ø­ Ø§Ù„Ø£Ù…Ø§Ù† ØºÙŠØ± ØµØ­ÙŠØ­');
    return;
  }

  // 2ï¸âƒ£ Check credentials (Supabase first, then localStorage)
  const users = await getUsersAsync();
  const user = users.find(u =>
    u.email === email &&
    u.password === pass &&
    u.is_admin === true &&
    u.is_active === true
  );

  if (!user) {
    setLoading(false);
    recordFail('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
    return;
  }

  // âœ… SUCCESS
  attempts = 0;
  sessionStorage.removeItem('adm_att');
  sessionStorage.removeItem('adm_lock');

  // Save session (same key as main app)
  sessionStorage.setItem('sbtp_user', JSON.stringify(user));
  sessionStorage.setItem('sbtp_admin_auth', '1'); // extra admin flag

  setLoading(false);
  showSuccess();

  // Show admin panel after brief delay, then redirect
  setTimeout(async () => {
    // Ø¥Ø¸Ù‡Ø§Ø± Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
    document.getElementById('adminPanel').style.display = 'block';
    document.body.style.alignItems = 'flex-start';
    document.body.style.overflow = 'auto';
    document.body.style.paddingTop = '2rem';
    await loadUsersPanel();
    // ØªØ­Ø¯ÙŠØ« footer Ø¨Ø±Ø§Ø¨Ø· Ø§Ù„Ø°Ù‡Ø§Ø¨ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚
    const footer = document.querySelector('.card-footer');
    if (footer) footer.innerHTML = `
      <a class=\"back-link\" onclick=\"window.location.href='index.html#admin'\" style=\"color:#34C38F\">â† Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    `;
  }, 1000);
}

function recordFail(msg) {
  attempts++;
  sessionStorage.setItem('adm_att', attempts);
  renderDots();

  const remaining = ADMIN_CONFIG.maxAttempts - attempts;

  if (attempts >= ADMIN_CONFIG.maxAttempts) {
    lockUntil = Date.now() + ADMIN_CONFIG.lockoutMinutes * 60 * 1000;
    sessionStorage.setItem('adm_lock', lockUntil);
    showLockout();
    startCountdown();
  } else {
    showError(msg + (remaining > 0 ? ` â€” ØªØ¨Ù‚Ù‰ ${remaining} Ù…Ø­Ø§ÙˆÙ„Ø©` : ''));
  }
}

function setLoading(on) {
  const btn = document.getElementById('loginBtn');
  const txt = document.getElementById('btnText');
  const sp  = document.getElementById('spinner');
  btn.disabled = on;
  txt.style.display = on ? 'none' : 'inline';
  sp.style.display  = on ? 'block' : 'none';
}

function showError(msg) {
  const el = document.getElementById('alertError');
  document.getElementById('alertMsg').textContent = msg;
  el.style.display = 'flex';
  setTimeout(() => el.style.display = 'none', 4000);
}

function showLockout() {
  document.getElementById('formContent').style.display = 'none';
  document.getElementById('lockoutState').style.display = 'block';
  document.getElementById('successState').style.display = 'none';
}

function showSuccess() {
  document.getElementById('formContent').style.display = 'none';
  document.getElementById('lockoutState').style.display = 'none';
  document.getElementById('successState').style.display = 'block';
}

function startCountdown() {
  const el = document.getElementById('lockTimer');
  function tick() {
    const rem = Math.max(0, lockUntil - Date.now());
    if (rem <= 0) {
      window.location.reload();
      return;
    }
    const m = Math.floor(rem / 60000);
    const s = Math.floor((rem % 60000) / 1000);
    el.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    setTimeout(tick, 1000);
  }
  tick();
}

function togglePass() {
  const p = document.getElementById('adminPass');
  p.type = p.type === 'password' ? 'text' : 'password';
}

function goBack() {
  window.location.href = 'index.html';
}

function delay(ms) { return new Promise(r => setTimeout(r, ms)); }
</script>
</body>
</html>
